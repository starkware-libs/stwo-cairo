use crate::channel::Channel;
use crate::circle::{CirclePointIndexImpl, CosetImpl};
use crate::fields::qm31::qm31_const;
use crate::fri::{FriConfig, FriVerifierImpl, FriVerifierTrait};
use crate::poly::circle::CircleEvaluationImpl;
use crate::poly::line::LineDomainImpl;
use crate::queries::{Queries, QueriesImpl};

#[test]
fn valid_proof_passes_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 4;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<1242514872, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 1381744584, 0, 0, 0, 5, 3408058756, 3332009875, 2004129465, 1339824844, 4291374648,
        354770876, 3938102254, 3052532404, 1069035520, 1523687579, 4018306790, 3813862724,
        815560613, 2474119663, 3583515229, 2797747106, 3165096981, 1366525257, 1662465633,
        2804277966, 3793812067, 3048080764, 2136248069, 393899174, 1444017448, 1437902970,
        3212256732, 4073949526, 3424084775, 4223870852, 4075965989, 3917701606, 1160688958,
        1066523708, 2323385995, 4265415136, 4273652407, 2027884439, 1832416271, 3368607174,
        3181191510, 1881002254, 2850990160, 3950795056, 2025662249, 71432671, 1721708891, 899417501,
        3, 1, 436886998, 832124673, 452809361, 2092862148, 4, 511671619, 1737206869, 4171972349,
        1757765635, 3588062374, 2186346179, 3172945760, 3258540880, 2117617384, 4004888929,
        1221708909, 3768532342, 2436044836, 2804654421, 3996742314, 3137556454, 3038839336,
        4134565178, 3721981860, 2343611490, 3710140276, 2133712429, 367577089, 795652878,
        3001244329, 1830323941, 188933688, 2806939785, 2155390748, 4085906955, 4178857208,
        188137254, 2306582933, 972749922, 3514598821, 547067959, 451993149, 3489855439, 4061972958,
        3591478563, 1, 532088767, 1727150247, 789490699, 1502694462, 3, 247687293, 2283809047,
        917665061, 3432040078, 2812469893, 2357755711, 2289715119, 3835168667, 2817681374,
        2994220683, 1220545017, 4272005985, 583950929, 1235182509, 3350486125, 2808164034,
        227716526, 1115027974, 2417002839, 2351856917, 2447560587, 1297123861, 2163299217,
        1841854141, 185547476, 3705542750, 1504534351, 927860320, 3463305474, 939361814, 1236575955,
        2619462136, 1, 1015878161, 2052519750, 1815876388, 1220014814, 2, 2274435826, 2696282295,
        2328221230, 1510793889, 1674328371, 786627740, 444672288, 1508582054, 4081193818, 967673921,
        1898331706, 2118670578, 657220952, 1863623153, 3468969543, 820400902, 3199456321,
        4074834261, 263095874, 2937562954, 2758355391, 2361619954, 3566203264, 3023614298, 1,
        317194111, 1498301053, 1067498304, 1440151575, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}


#[test]
#[should_panic]
fn proof_with_invalid_inner_layer_evaluation_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<511282811, 0, 0, 0>()].span();
    // The proof is missing the first element of the second layer's fri witness.
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7, 550388529, 2193427406, 2495770517, 3735287237, 1386100235,
        1177556105, 1525572632, 1804821649, 4291795923, 1872399013, 1648371290, 3613802267,
        3012870004, 4143468990, 2062177395, 2230954374, 3020407000, 717574600, 2525603435,
        1377905559, 402134711, 1859358582, 994461983, 2330877843, 1997254543, 1102439929,
        1504098291, 301131224, 1588531628, 792079342, 3864133624, 2686740900, 1060835525,
        3847581803, 816847709, 4125110679, 565130439, 3426578801, 3352009324, 1684581009, 501768855,
        1740815256, 3405841461, 2146183867, 931605871, 3727350027, 2384626214, 498581854,
        1022971233, 197643979, 246966562, 1094036311, 1460888986, 1844666247, 1037850483,
        2289157815, 2881169349, 1330043444, 2703350465, 3496651765, 3725467362, 2404873539,
        1079736950, 1670148759, 5, 1, 1656178590, 521435076, 681089442, 767743476, 6, 3569159702,
        886645570, 1184167075, 4094356973, 1772501880, 636944858, 1280561328, 2664436154,
        3260729459, 1232014112, 502815006, 2333551105, 659295501, 2362437369, 1170180504,
        2079780529, 3982536079, 613445921, 471272037, 1790423452, 3366022903, 2017287626, 586695875,
        2433387232, 2880390799, 2631588726, 4077183452, 2606962921, 1511414280, 1537828292,
        2324636341, 3862111866, 2850900024, 3686012875, 856309191, 3850597843, 459946528, 181498622,
        1664646054, 429206777, 1348023396, 3684557546, 2373186311, 3694667313, 836463748,
        1214914829, 2116982835, 1708081764, 3444027982, 2722313282, 3158815024, 797259827,
        3822109504, 637111119, 4196679836, 2167503946, 1, 5, 3644802199, 189908579, 2109961608,
        2708567895, 3478984006, 1305226852, 3309025190, 610432073, 2690249436, 2290666040,
        2162456495, 771290839, 2022488246, 2322968250, 2502749407, 2665961848, 616809327, 186793015,
        679422708, 3073996704, 750015288, 658247322, 3816925095, 3597480128, 2994507397, 2440768347,
        3978895942, 123735816, 954274824, 507108670, 810651335, 3251707605, 1814813610, 2955937465,
        4154604950, 511988928, 2255459804, 3472486244, 3991200202, 1751684551, 258957380,
        3873231883, 1516387538, 468400756, 4202034755, 2557812003, 2435492240, 1300525310, 1,
        413784971, 361021879, 1258103802, 509618802, 4, 4267638565, 2090087182, 1340120100,
        670520707, 506869072, 3343221255, 3883332813, 959690288, 211889552, 3461920916, 1774119468,
        465188731, 3196310160, 3807754188, 2739351528, 3452236185, 2225325379, 2075957463,
        1313700778, 2678509908, 331617563, 4195158078, 2817760514, 1047355145, 3098456853,
        1753298952, 1960215135, 367147881, 299346729, 3117399584, 1579291699, 69442942, 2633964307,
        3531401927, 187771316, 3628426296, 2328861415, 158892794, 3068582428, 3480358375, 1,
        954332933, 492451615, 2092352772, 912176217, 3, 3662223828, 3254938692, 2029811936,
        1967152030, 1431016252, 3486647458, 3656982601, 4146842653, 1888340134, 2379417163,
        1520996693, 2441092681, 1717957284, 4281732767, 2810990869, 4237967424, 3332976496,
        4257184110, 2489763298, 3599357832, 125027211, 3968256743, 2804866078, 1167682051,
        1667388797, 1752327375, 213998679, 4125228971, 3175318899, 3502133183, 1109035346,
        1583148317, 1, 1962533830, 371104443, 1139491511, 56875719, 2, 4238733511, 2969925830,
        3241988732, 483371485, 305381809, 1116551851, 396466760, 998704631, 2140827005, 4186103405,
        1457209152, 2306076745, 2603762003, 3946354839, 1799358389, 611711256, 829812436,
        4211107481, 364791883, 3224589244, 330544689, 108786623, 802183770, 1076851452, 1,
        1861325726, 897689017, 804860205, 2118313633, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
fn proof_with_added_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 1, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The proof is created with a fri config with log_last_layer_degree_bound = 0, so the verifier
    // receives one more layer than it expects.
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7, 550388529, 2193427406, 2495770517, 3735287237, 1386100235,
        1177556105, 1525572632, 1804821649, 4291795923, 1872399013, 1648371290, 3613802267,
        3012870004, 4143468990, 2062177395, 2230954374, 3020407000, 717574600, 2525603435,
        1377905559, 402134711, 1859358582, 994461983, 2330877843, 1997254543, 1102439929,
        1504098291, 301131224, 1588531628, 792079342, 3864133624, 2686740900, 1060835525,
        3847581803, 816847709, 4125110679, 565130439, 3426578801, 3352009324, 1684581009, 501768855,
        1740815256, 3405841461, 2146183867, 931605871, 3727350027, 2384626214, 498581854,
        1022971233, 197643979, 246966562, 1094036311, 1460888986, 1844666247, 1037850483,
        2289157815, 2881169349, 1330043444, 2703350465, 3496651765, 3725467362, 2404873539,
        1079736950, 1670148759, 5, 1, 1656178590, 521435076, 681089442, 767743476, 6, 3569159702,
        886645570, 1184167075, 4094356973, 1772501880, 636944858, 1280561328, 2664436154,
        3260729459, 1232014112, 502815006, 2333551105, 659295501, 2362437369, 1170180504,
        2079780529, 3982536079, 613445921, 471272037, 1790423452, 3366022903, 2017287626, 586695875,
        2433387232, 2880390799, 2631588726, 4077183452, 2606962921, 1511414280, 1537828292,
        2324636341, 3862111866, 2850900024, 3686012875, 856309191, 3850597843, 459946528, 181498622,
        1664646054, 429206777, 1348023396, 3684557546, 2373186311, 3694667313, 836463748,
        1214914829, 2116982835, 1708081764, 3444027982, 2722313282, 3158815024, 797259827,
        3822109504, 637111119, 4196679836, 2167503946, 1, 1180839831, 764720955, 410085831,
        1564061246, 5, 3644802199, 189908579, 2109961608, 2708567895, 3478984006, 1305226852,
        3309025190, 610432073, 2690249436, 2290666040, 2162456495, 771290839, 2022488246,
        2322968250, 2502749407, 2665961848, 616809327, 186793015, 679422708, 3073996704, 750015288,
        658247322, 3816925095, 3597480128, 2994507397, 2440768347, 3978895942, 123735816, 954274824,
        507108670, 810651335, 3251707605, 1814813610, 2955937465, 4154604950, 511988928, 2255459804,
        3472486244, 3991200202, 1751684551, 258957380, 3873231883, 1516387538, 468400756,
        4202034755, 2557812003, 2435492240, 1300525310, 1, 413784971, 361021879, 1258103802,
        509618802, 4, 4267638565, 2090087182, 1340120100, 670520707, 506869072, 3343221255,
        3883332813, 959690288, 211889552, 3461920916, 1774119468, 465188731, 3196310160, 3807754188,
        2739351528, 3452236185, 2225325379, 2075957463, 1313700778, 2678509908, 331617563,
        4195158078, 2817760514, 1047355145, 3098456853, 1753298952, 1960215135, 367147881,
        299346729, 3117399584, 1579291699, 69442942, 2633964307, 3531401927, 187771316, 3628426296,
        2328861415, 158892794, 3068582428, 3480358375, 1, 954332933, 492451615, 2092352772,
        912176217, 3, 3662223828, 3254938692, 2029811936, 1967152030, 1431016252, 3486647458,
        3656982601, 4146842653, 1888340134, 2379417163, 1520996693, 2441092681, 1717957284,
        4281732767, 2810990869, 4237967424, 3332976496, 4257184110, 2489763298, 3599357832,
        125027211, 3968256743, 2804866078, 1167682051, 1667388797, 1752327375, 213998679,
        4125228971, 3175318899, 3502133183, 1109035346, 1583148317, 1, 1962533830, 371104443,
        1139491511, 56875719, 2, 4238733511, 2969925830, 3241988732, 483371485, 305381809,
        1116551851, 396466760, 998704631, 2140827005, 4186103405, 1457209152, 2306076745,
        2603762003, 3946354839, 1799358389, 611711256, 829812436, 4211107481, 364791883, 3224589244,
        330544689, 108786623, 802183770, 1076851452, 1, 1861325726, 897689017, 804860205,
        2118313633, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
fn proof_with_removed_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The proof is created with a fri config with log_last_layer_degree_bound = 1, so the verifier
    // expects another layer.
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7, 550388529, 2193427406, 2495770517, 3735287237, 1386100235,
        1177556105, 1525572632, 1804821649, 4291795923, 1872399013, 1648371290, 3613802267,
        3012870004, 4143468990, 2062177395, 2230954374, 3020407000, 717574600, 2525603435,
        1377905559, 402134711, 1859358582, 994461983, 2330877843, 1997254543, 1102439929,
        1504098291, 301131224, 1588531628, 792079342, 3864133624, 2686740900, 1060835525,
        3847581803, 816847709, 4125110679, 565130439, 3426578801, 3352009324, 1684581009, 501768855,
        1740815256, 3405841461, 2146183867, 931605871, 3727350027, 2384626214, 498581854,
        1022971233, 197643979, 246966562, 1094036311, 1460888986, 1844666247, 1037850483,
        2289157815, 2881169349, 1330043444, 2703350465, 3496651765, 3725467362, 2404873539,
        1079736950, 1670148759, 4, 1, 1656178590, 521435076, 681089442, 767743476, 6, 3569159702,
        886645570, 1184167075, 4094356973, 1772501880, 636944858, 1280561328, 2664436154,
        3260729459, 1232014112, 502815006, 2333551105, 659295501, 2362437369, 1170180504,
        2079780529, 3982536079, 613445921, 471272037, 1790423452, 3366022903, 2017287626, 586695875,
        2433387232, 2880390799, 2631588726, 4077183452, 2606962921, 1511414280, 1537828292,
        2324636341, 3862111866, 2850900024, 3686012875, 856309191, 3850597843, 459946528, 181498622,
        1664646054, 429206777, 1348023396, 3684557546, 2373186311, 3694667313, 836463748,
        1214914829, 2116982835, 1708081764, 3444027982, 2722313282, 3158815024, 797259827,
        3822109504, 637111119, 4196679836, 2167503946, 1, 1180839831, 764720955, 410085831,
        1564061246, 5, 3644802199, 189908579, 2109961608, 2708567895, 3478984006, 1305226852,
        3309025190, 610432073, 2690249436, 2290666040, 2162456495, 771290839, 2022488246,
        2322968250, 2502749407, 2665961848, 616809327, 186793015, 679422708, 3073996704, 750015288,
        658247322, 3816925095, 3597480128, 2994507397, 2440768347, 3978895942, 123735816, 954274824,
        507108670, 810651335, 3251707605, 1814813610, 2955937465, 4154604950, 511988928, 2255459804,
        3472486244, 3991200202, 1751684551, 258957380, 3873231883, 1516387538, 468400756,
        4202034755, 2557812003, 2435492240, 1300525310, 1, 413784971, 361021879, 1258103802,
        509618802, 4, 4267638565, 2090087182, 1340120100, 670520707, 506869072, 3343221255,
        3883332813, 959690288, 211889552, 3461920916, 1774119468, 465188731, 3196310160, 3807754188,
        2739351528, 3452236185, 2225325379, 2075957463, 1313700778, 2678509908, 331617563,
        4195158078, 2817760514, 1047355145, 3098456853, 1753298952, 1960215135, 367147881,
        299346729, 3117399584, 1579291699, 69442942, 2633964307, 3531401927, 187771316, 3628426296,
        2328861415, 158892794, 3068582428, 3480358375, 1, 954332933, 492451615, 2092352772,
        912176217, 3, 3662223828, 3254938692, 2029811936, 1967152030, 1431016252, 3486647458,
        3656982601, 4146842653, 1888340134, 2379417163, 1520996693, 2441092681, 1717957284,
        4281732767, 2810990869, 4237967424, 3332976496, 4257184110, 2489763298, 3599357832,
        125027211, 3968256743, 2804866078, 1167682051, 1667388797, 1752327375, 213998679,
        4125228971, 3175318899, 3502133183, 1109035346, 1583148317, 2, 930589827, 460705353,
        1400041064, 2107474802, 930589827, 460705353, 1400041064, 2107474802, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid last layer degree")]
fn proof_with_invalid_last_layer_degree_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The last layer polynomial has degree 1, not 0.
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7, 550388529, 2193427406, 2495770517, 3735287237, 1386100235,
        1177556105, 1525572632, 1804821649, 4291795923, 1872399013, 1648371290, 3613802267,
        3012870004, 4143468990, 2062177395, 2230954374, 3020407000, 717574600, 2525603435,
        1377905559, 402134711, 1859358582, 994461983, 2330877843, 1997254543, 1102439929,
        1504098291, 301131224, 1588531628, 792079342, 3864133624, 2686740900, 1060835525,
        3847581803, 816847709, 4125110679, 565130439, 3426578801, 3352009324, 1684581009, 501768855,
        1740815256, 3405841461, 2146183867, 931605871, 3727350027, 2384626214, 498581854,
        1022971233, 197643979, 246966562, 1094036311, 1460888986, 1844666247, 1037850483,
        2289157815, 2881169349, 1330043444, 2703350465, 3496651765, 3725467362, 2404873539,
        1079736950, 1670148759, 5, 1, 1656178590, 521435076, 681089442, 767743476, 6, 3569159702,
        886645570, 1184167075, 4094356973, 1772501880, 636944858, 1280561328, 2664436154,
        3260729459, 1232014112, 502815006, 2333551105, 659295501, 2362437369, 1170180504,
        2079780529, 3982536079, 613445921, 471272037, 1790423452, 3366022903, 2017287626, 586695875,
        2433387232, 2880390799, 2631588726, 4077183452, 2606962921, 1511414280, 1537828292,
        2324636341, 3862111866, 2850900024, 3686012875, 856309191, 3850597843, 459946528, 181498622,
        1664646054, 429206777, 1348023396, 3684557546, 2373186311, 3694667313, 836463748,
        1214914829, 2116982835, 1708081764, 3444027982, 2722313282, 3158815024, 797259827,
        3822109504, 637111119, 4196679836, 2167503946, 1, 1180839831, 764720955, 410085831,
        1564061246, 5, 3644802199, 189908579, 2109961608, 2708567895, 3478984006, 1305226852,
        3309025190, 610432073, 2690249436, 2290666040, 2162456495, 771290839, 2022488246,
        2322968250, 2502749407, 2665961848, 616809327, 186793015, 679422708, 3073996704, 750015288,
        658247322, 3816925095, 3597480128, 2994507397, 2440768347, 3978895942, 123735816, 954274824,
        507108670, 810651335, 3251707605, 1814813610, 2955937465, 4154604950, 511988928, 2255459804,
        3472486244, 3991200202, 1751684551, 258957380, 3873231883, 1516387538, 468400756,
        4202034755, 2557812003, 2435492240, 1300525310, 1, 413784971, 361021879, 1258103802,
        509618802, 4, 4267638565, 2090087182, 1340120100, 670520707, 506869072, 3343221255,
        3883332813, 959690288, 211889552, 3461920916, 1774119468, 465188731, 3196310160, 3807754188,
        2739351528, 3452236185, 2225325379, 2075957463, 1313700778, 2678509908, 331617563,
        4195158078, 2817760514, 1047355145, 3098456853, 1753298952, 1960215135, 367147881,
        299346729, 3117399584, 1579291699, 69442942, 2633964307, 3531401927, 187771316, 3628426296,
        2328861415, 158892794, 3068582428, 3480358375, 1, 954332933, 492451615, 2092352772,
        912176217, 3, 3662223828, 3254938692, 2029811936, 1967152030, 1431016252, 3486647458,
        3656982601, 4146842653, 1888340134, 2379417163, 1520996693, 2441092681, 1717957284,
        4281732767, 2810990869, 4237967424, 3332976496, 4257184110, 2489763298, 3599357832,
        125027211, 3968256743, 2804866078, 1167682051, 1667388797, 1752327375, 213998679,
        4125228971, 3175318899, 3502133183, 1109035346, 1583148317, 1, 1962533830, 371104443,
        1139491511, 56875719, 2, 4238733511, 2969925830, 3241988732, 483371485, 305381809,
        1116551851, 396466760, 998704631, 2140827005, 4186103405, 1457209152, 2306076745,
        2603762003, 3946354839, 1799358389, 611711256, 829812436, 4211107481, 364791883, 3224589244,
        330544689, 108786623, 802183770, 1076851452, 2, 0, 0, 0, 1, 1861325726, 897689017,
        804860205, 2118313633, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid last layer evaluations")]
fn proof_with_invalid_last_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![1, 7, 8].span(), log_domain_size: column_log_size };
    let query_evals = array![
        qm31_const::<1208798379, 0, 0, 0>(), qm31_const::<1086480365, 0, 0, 0>(),
        qm31_const::<1362010196, 0, 0, 0>(),
    ]
        .span();
    let mut proof_data = array![
        3, 13485189, 0, 0, 0, 526587957, 0, 0, 0, 84215338, 0, 0, 0, 8, 637558780, 2874468961,
        1900743590, 3265256014, 2921955179, 1091105173, 3305420150, 3673380213, 1227526681,
        1684593538, 79134275, 2338975088, 2074582452, 102378997, 1664681936, 224227484, 4105318068,
        4133080715, 2730668420, 4267929948, 3252782874, 437254607, 2557531660, 3116264755,
        396787042, 2303453822, 2964699308, 3882795685, 3532202716, 2551624915, 1062641626,
        3934580155, 1997254543, 1102439929, 1504098291, 301131224, 1588531628, 792079342,
        3864133624, 2686740900, 1060835525, 3847581803, 816847709, 4125110679, 565130439,
        3426578801, 3352009324, 1684581009, 501768855, 1740815256, 3405841461, 2146183867,
        931605871, 3727350027, 2384626214, 498581854, 1022971233, 197643979, 246966562, 1094036311,
        1460888986, 1844666247, 1037850483, 2289157815, 2881169349, 1330043444, 2703350465,
        3496651765, 3725467362, 2404873539, 1079736950, 1670148759, 5, 3, 333947864, 2110925552,
        746901465, 239273226, 1482547985, 497516222, 1949972219, 421708523, 1999313255, 1509599119,
        715278838, 1995713243, 5, 1196824974, 1637950207, 2591535340, 3957193664, 2829595744,
        1390930309, 657840386, 1226439703, 3982536079, 613445921, 471272037, 1790423452, 3366022903,
        2017287626, 586695875, 2433387232, 2880390799, 2631588726, 4077183452, 2606962921,
        1511414280, 1537828292, 2324636341, 3862111866, 2850900024, 3686012875, 856309191,
        3850597843, 459946528, 181498622, 1664646054, 429206777, 1348023396, 3684557546, 2373186311,
        3694667313, 836463748, 1214914829, 2116982835, 1708081764, 3444027982, 2722313282,
        3158815024, 797259827, 3822109504, 637111119, 4196679836, 2167503946, 1, 1835808151,
        2115791412, 891350096, 450885138, 4, 2690249436, 2290666040, 2162456495, 771290839,
        2022488246, 2322968250, 2502749407, 2665961848, 616809327, 186793015, 679422708, 3073996704,
        750015288, 658247322, 3816925095, 3597480128, 2994507397, 2440768347, 3978895942, 123735816,
        954274824, 507108670, 810651335, 3251707605, 1814813610, 2955937465, 4154604950, 511988928,
        2255459804, 3472486244, 3991200202, 1751684551, 258957380, 3873231883, 1516387538,
        468400756, 4202034755, 2557812003, 2435492240, 1300525310, 0, 4, 4267638565, 2090087182,
        1340120100, 670520707, 506869072, 3343221255, 3883332813, 959690288, 211889552, 3461920916,
        1774119468, 465188731, 3196310160, 3807754188, 2739351528, 3452236185, 2225325379,
        2075957463, 1313700778, 2678509908, 331617563, 4195158078, 2817760514, 1047355145,
        3098456853, 1753298952, 1960215135, 367147881, 299346729, 3117399584, 1579291699, 69442942,
        2633964307, 3531401927, 187771316, 3628426296, 2328861415, 158892794, 3068582428,
        3480358375, 1, 954332933, 492451615, 2092352772, 912176217, 3, 3662223828, 3254938692,
        2029811936, 1967152030, 1431016252, 3486647458, 3656982601, 4146842653, 1888340134,
        2379417163, 1520996693, 2441092681, 1717957284, 4281732767, 2810990869, 4237967424,
        3332976496, 4257184110, 2489763298, 3599357832, 125027211, 3968256743, 2804866078,
        1167682051, 1667388797, 1752327375, 213998679, 4125228971, 3175318899, 3502133183,
        1109035346, 1583148317, 1, 1962533830, 371104443, 1139491511, 56875719, 2, 4238733511,
        2969925830, 3241988732, 483371485, 305381809, 1116551851, 396466760, 998704631, 2140827005,
        4186103405, 1457209152, 2306076745, 2603762003, 3946354839, 1799358389, 611711256,
        829812436, 4211107481, 364791883, 3224589244, 330544689, 108786623, 802183770, 1076851452,
        1, 1861325726, 897689017, 804860205, 2118313635, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

#[test]
#[should_panic]
fn decommit_queries_on_invalid_domain_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let invalid_column_log_size = column_log_size - 1;
    let invalid_queries = Queries {
        positions: array![1, 7, 8].span(), log_domain_size: invalid_column_log_size,
    };
    let query_evals = array![
        qm31_const::<1208798379, 0, 0, 0>(), qm31_const::<1086480365, 0, 0, 0>(),
        qm31_const::<1362010196, 0, 0, 0>(),
    ]
        .span();
    let mut proof_data = array![
        3, 13485189, 0, 0, 0, 526587957, 0, 0, 0, 84215338, 0, 0, 0, 8, 637558780, 2874468961,
        1900743590, 3265256014, 2921955179, 1091105173, 3305420150, 3673380213, 1227526681,
        1684593538, 79134275, 2338975088, 2074582452, 102378997, 1664681936, 224227484, 4105318068,
        4133080715, 2730668420, 4267929948, 3252782874, 437254607, 2557531660, 3116264755,
        396787042, 2303453822, 2964699308, 3882795685, 3532202716, 2551624915, 1062641626,
        3934580155, 1997254543, 1102439929, 1504098291, 301131224, 1588531628, 792079342,
        3864133624, 2686740900, 1060835525, 3847581803, 816847709, 4125110679, 565130439,
        3426578801, 3352009324, 1684581009, 501768855, 1740815256, 3405841461, 2146183867,
        931605871, 3727350027, 2384626214, 498581854, 1022971233, 197643979, 246966562, 1094036311,
        1460888986, 1844666247, 1037850483, 2289157815, 2881169349, 1330043444, 2703350465,
        3496651765, 3725467362, 2404873539, 1079736950, 1670148759, 5, 3, 333947864, 2110925552,
        746901465, 239273226, 1482547985, 497516222, 1949972219, 421708523, 1999313255, 1509599119,
        715278838, 1995713243, 5, 1196824974, 1637950207, 2591535340, 3957193664, 2829595744,
        1390930309, 657840386, 1226439703, 3982536079, 613445921, 471272037, 1790423452, 3366022903,
        2017287626, 586695875, 2433387232, 2880390799, 2631588726, 4077183452, 2606962921,
        1511414280, 1537828292, 2324636341, 3862111866, 2850900024, 3686012875, 856309191,
        3850597843, 459946528, 181498622, 1664646054, 429206777, 1348023396, 3684557546, 2373186311,
        3694667313, 836463748, 1214914829, 2116982835, 1708081764, 3444027982, 2722313282,
        3158815024, 797259827, 3822109504, 637111119, 4196679836, 2167503946, 1, 1835808151,
        2115791412, 891350096, 450885138, 4, 2690249436, 2290666040, 2162456495, 771290839,
        2022488246, 2322968250, 2502749407, 2665961848, 616809327, 186793015, 679422708, 3073996704,
        750015288, 658247322, 3816925095, 3597480128, 2994507397, 2440768347, 3978895942, 123735816,
        954274824, 507108670, 810651335, 3251707605, 1814813610, 2955937465, 4154604950, 511988928,
        2255459804, 3472486244, 3991200202, 1751684551, 258957380, 3873231883, 1516387538,
        468400756, 4202034755, 2557812003, 2435492240, 1300525310, 0, 4, 4267638565, 2090087182,
        1340120100, 670520707, 506869072, 3343221255, 3883332813, 959690288, 211889552, 3461920916,
        1774119468, 465188731, 3196310160, 3807754188, 2739351528, 3452236185, 2225325379,
        2075957463, 1313700778, 2678509908, 331617563, 4195158078, 2817760514, 1047355145,
        3098456853, 1753298952, 1960215135, 367147881, 299346729, 3117399584, 1579291699, 69442942,
        2633964307, 3531401927, 187771316, 3628426296, 2328861415, 158892794, 3068582428,
        3480358375, 1, 954332933, 492451615, 2092352772, 912176217, 3, 3662223828, 3254938692,
        2029811936, 1967152030, 1431016252, 3486647458, 3656982601, 4146842653, 1888340134,
        2379417163, 1520996693, 2441092681, 1717957284, 4281732767, 2810990869, 4237967424,
        3332976496, 4257184110, 2489763298, 3599357832, 125027211, 3968256743, 2804866078,
        1167682051, 1667388797, 1752327375, 213998679, 4125228971, 3175318899, 3502133183,
        1109035346, 1583148317, 1, 1962533830, 371104443, 1139491511, 56875719, 2, 4238733511,
        2969925830, 3241988732, 483371485, 305381809, 1116551851, 396466760, 998704631, 2140827005,
        4186103405, 1457209152, 2306076745, 2603762003, 3946354839, 1799358389, 611711256,
        829812436, 4211107481, 364791883, 3224589244, 330544689, 108786623, 802183770, 1076851452,
        1, 1861325726, 897689017, 804860205, 2118313633, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(invalid_queries, query_evals);
}
