use crate::channel::Channel;
use crate::circle::{CirclePointIndexImpl, CosetImpl};
use crate::fields::qm31::qm31_const;
use crate::fri::{FriConfig, FriVerifierImpl, FriVerifierTrait};
use crate::poly::circle::CircleEvaluationImpl;
use crate::poly::line::LineDomainImpl;
use crate::queries::{Queries, QueriesImpl};

#[test]
/// The test data was generated using [`stwo::core::fri::tests::valid_proof_passes_verification`]
/// on commit c66302ae7afaa09e6e9fe8a5039094100121d673.
fn valid_proof_passes_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 4;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<1242514872, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 1381744584, 0, 0, 0, 5, 4013379, 1620929195, 196343493, 1455531721, 881800319, 973958561,
        515015194, 2957237480, 1739168948, 1822972178, 137215804, 3065987771, 790119596, 2647928575,
        2106646785, 2836027847, 1844229270, 1959818569, 117777213, 1466604405, 2536025723,
        538626464, 1936417924, 1642662501, 1424301016, 4137186479, 1842735475, 1303274907,
        3949390009, 2946331165, 2559384885, 2301899931, 2907659736, 1465157386, 2016990839,
        3818161157, 2080613041, 2235471399, 3899041440, 3635740593, 101198709, 3972202971,
        3427315150, 3605974943, 2254078578, 3928553922, 516141456, 1185568119, 3, 1, 1138579881,
        1203263176, 1698903819, 1490840219, 4, 1049054789, 997960059, 2392122435, 4098564151,
        3582028509, 1187891063, 1300784580, 3939608293, 2490381402, 1779347168, 1127768162,
        195780834, 125898282, 1227732400, 287962228, 737503816, 3298757151, 4271345519, 1790869744,
        732093805, 991043384, 2989698167, 2633482746, 618549418, 1378069114, 2487743860, 1757435193,
        577071361, 3887172531, 1747219981, 1196520359, 222729807, 3146925864, 4216961222,
        2830599487, 3628196185, 1986104303, 3983407184, 502873541, 3517199403, 1, 1075183469,
        1575798514, 1395277133, 1416921027, 3, 874955184, 3595081991, 1977474679, 1960195677,
        2886657178, 3549715074, 3966883062, 3144161820, 2169229851, 2268245366, 3546515055,
        2354962466, 231658785, 2069066136, 1890024204, 2305426549, 1135911259, 677692172,
        2123918614, 568291494, 475375909, 1852107204, 348795881, 354008558, 2275883557, 106188300,
        82886892, 1154457209, 2149170495, 3542691658, 2492135274, 1777383738, 1, 544453988,
        2014474910, 625298233, 283117908, 2, 4250341689, 2127630487, 3117648992, 3053348341,
        3631691535, 643449251, 3265850252, 1278163703, 277899999, 4207194110, 3511290204,
        3538554262, 1347652611, 1305822581, 893600307, 2612606245, 573878832, 3205656822,
        3163430290, 1911743041, 1188274163, 3275532137, 3947542220, 31441167, 1, 534085537,
        1785711003, 931881102, 1503633061, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}


#[test]
#[should_panic]
fn proof_with_invalid_inner_layer_evaluation_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<511282811, 0, 0, 0>()].span();
    // The proof is missing the first element of the second layer's fri witness.
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7, 2630196203, 2702520654, 1385922681, 202920142, 3292993882,
        3904654697, 1685185838, 4074913318, 2689362261, 1544844228, 815539921, 1084863242,
        3296088483, 847102984, 1499328643, 598075978, 1341622493, 3509590667, 3944602181,
        4060530797, 3380169544, 1157610312, 1872689990, 2141220171, 4226953668, 4111689355,
        4085228277, 2534011746, 2702047246, 1796723545, 805991809, 4264028877, 1622198621,
        3132153353, 4069492091, 3348244485, 243523157, 3900443470, 682718364, 3980434338,
        1090002601, 3413214276, 202004026, 2277978075, 3329882806, 964129743, 33493855, 1386628738,
        964597192, 2776971243, 3214987103, 3114412783, 4096873747, 1991897439, 1320631548,
        3720795382, 2581098863, 2321559817, 458876584, 1582964031, 1494983747, 2808349651,
        2993436627, 4209579, 3, 1, 1056544440, 544398534, 1065028452, 1934705747, 6, 2603751619,
        3925267916, 892640517, 3673844768, 3338634828, 456070477, 4111777558, 1302504557,
        3626907078, 1767424930, 928770556, 1358239302, 2248049096, 115848421, 1191298443,
        3555495242, 3463625314, 860812537, 3058246234, 4073668375, 1878641723, 3663354012,
        449046214, 3123252198, 2014498544, 336016064, 3568692538, 1369549658, 960565639, 1058345091,
        907583503, 926991181, 2327490371, 1318526341, 1586259481, 1200199099, 1106241778,
        2135610413, 629352393, 266117733, 4018223549, 2834567659, 2843069568, 737214622, 41519050,
        2068133468, 2796529079, 3439123190, 2788099764, 4270416216, 317743227, 3107337037,
        346798116, 3096452908, 3961382707, 69387443, 0, 5, 1916015761, 729535613, 3511376996,
        924350602, 1598540621, 2155115788, 3789846558, 247373397, 1115549449, 4206905300,
        2492524322, 151972377, 2136385346, 2307522379, 2904654443, 3131367782, 1940944350,
        1520720360, 3208962193, 2008936861, 3655478230, 4087763537, 1996538171, 1603514391,
        762161481, 2158456288, 4266770756, 3167446373, 1073580577, 328879579, 1760038296,
        3377086102, 2715585292, 1084744010, 1652360621, 1735579658, 1512891621, 4054941899,
        829987954, 2398868888, 2512578114, 1000387327, 4036904336, 1732585137, 2217966532,
        2911347829, 4155975348, 2998158577, 1, 1424553579, 1489788301, 1207779628, 1492070822, 4,
        2463107068, 2396338984, 486589748, 3955035326, 2568022762, 3269196936, 3527326873,
        2682504389, 2543610324, 1666314299, 3156411093, 1660029376, 1341720898, 1233881558,
        286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473, 3316675183, 428630443,
        917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132, 3888923447,
        2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664, 1394083249,
        2985963938, 1096029287, 2937190762, 923831270, 4, 852475931, 1804896245, 840783934,
        2087679062, 852475931, 1804896245, 840783934, 2087679062, 852475931, 1804896245, 840783934,
        2087679062, 852475931, 1804896245, 840783934, 2087679062, 2,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
fn proof_with_added_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 1, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The proof is created with a fri config with log_last_layer_degree_bound = 0, so the verifier
    // receives one more layer than it expects.
    let mut proof_data = array![
        1, 13485189, 0, 0, 0, 7, 1372005470, 2709444601, 8660353, 1197912763, 2097669106,
        2565886625, 3187301120, 2744122786, 2250434810, 3181375376, 3266303265, 3833375635,
        2532194441, 509336530, 653188657, 2618864049, 1341622493, 3509590667, 3944602181,
        4060530797, 3380169544, 1157610312, 1872689990, 2141220171, 4226953668, 4111689355,
        4085228277, 2534011746, 2702047246, 1796723545, 805991809, 4264028877, 1622198621,
        3132153353, 4069492091, 3348244485, 243523157, 3900443470, 682718364, 3980434338,
        1090002601, 3413214276, 202004026, 2277978075, 3329882806, 964129743, 33493855, 1386628738,
        964597192, 2776971243, 3214987103, 3114412783, 4096873747, 1991897439, 1320631548,
        3720795382, 2581098863, 2321559817, 458876584, 1582964031, 1494983747, 2808349651,
        2993436627, 4209579, 5, 1, 749787485, 1969956940, 1785657151, 2094492064, 6, 153727425,
        3923623490, 502231720, 1149216099, 64689942, 1412950283, 296595914, 724802863, 3626907078,
        1767424930, 928770556, 1358239302, 2248049096, 115848421, 1191298443, 3555495242,
        3463625314, 860812537, 3058246234, 4073668375, 1878641723, 3663354012, 449046214,
        3123252198, 2014498544, 336016064, 3568692538, 1369549658, 960565639, 1058345091, 907583503,
        926991181, 2327490371, 1318526341, 1586259481, 1200199099, 1106241778, 2135610413,
        629352393, 266117733, 4018223549, 2834567659, 2843069568, 737214622, 41519050, 2068133468,
        2796529079, 3439123190, 2788099764, 4270416216, 317743227, 3107337037, 346798116,
        3096452908, 3961382707, 69387443, 1, 1239304356, 169441334, 2078447559, 611157482, 5,
        1916015761, 729535613, 3511376996, 924350602, 1598540621, 2155115788, 3789846558, 247373397,
        1115549449, 4206905300, 2492524322, 151972377, 2136385346, 2307522379, 2904654443,
        3131367782, 1940944350, 1520720360, 3208962193, 2008936861, 3655478230, 4087763537,
        1996538171, 1603514391, 762161481, 2158456288, 4266770756, 3167446373, 1073580577,
        328879579, 1760038296, 3377086102, 2715585292, 1084744010, 1652360621, 1735579658,
        1512891621, 4054941899, 829987954, 2398868888, 2512578114, 1000387327, 4036904336,
        1732585137, 2217966532, 2911347829, 4155975348, 2998158577, 1, 1424553579, 1489788301,
        1207779628, 1492070822, 4, 2463107068, 2396338984, 486589748, 3955035326, 2568022762,
        3269196936, 3527326873, 2682504389, 2543610324, 1666314299, 3156411093, 1660029376,
        1341720898, 1233881558, 286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473,
        3316675183, 428630443, 917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132,
        3888923447, 2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664,
        1394083249, 2985963938, 1096029287, 2937190762, 923831270, 1, 998203232, 1168863975,
        2010373232, 569726986, 3, 2710609327, 2216448352, 1104255904, 2190316845, 559242392,
        2565995154, 1081987368, 3123961893, 3316524407, 2989286804, 350671860, 3444044780,
        3599867322, 3717955563, 2469206012, 3493114393, 2150232906, 2233083310, 4159520029,
        4177730940, 969076230, 3988867398, 641127349, 3760798772, 1579344412, 3733969299,
        3661667334, 2492379877, 1914207473, 2258450093, 2313970361, 3330590634, 1, 1289958476,
        1269481205, 629825842, 404343808, 2, 1997399982, 1150863623, 3077988537, 1592562720,
        4180644372, 3695902351, 1242183647, 2138757765, 157597396, 416205316, 1306999984,
        3134010864, 1159114009, 1404673145, 2096112828, 1034517045, 2667006062, 3451708558,
        2499812827, 3580127931, 1614802170, 1342722998, 2387660695, 3245972151, 1, 1578742030,
        1356219233, 1831594076, 1811208960, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
fn proof_with_removed_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The proof is created with a fri config with log_last_layer_degree_bound = 1, so the verifier
    // expects another layer.
    let mut proof_data = array![
        1, 13485189, 0, 0, 0, 7, 1372005470, 2709444601, 8660353, 1197912763, 2097669106,
        2565886625, 3187301120, 2744122786, 2250434810, 3181375376, 3266303265, 3833375635,
        2532194441, 509336530, 653188657, 2618864049, 1341622493, 3509590667, 3944602181,
        4060530797, 3380169544, 1157610312, 1872689990, 2141220171, 4226953668, 4111689355,
        4085228277, 2534011746, 2702047246, 1796723545, 805991809, 4264028877, 1622198621,
        3132153353, 4069492091, 3348244485, 243523157, 3900443470, 682718364, 3980434338,
        1090002601, 3413214276, 202004026, 2277978075, 3329882806, 964129743, 33493855, 1386628738,
        964597192, 2776971243, 3214987103, 3114412783, 4096873747, 1991897439, 1320631548,
        3720795382, 2581098863, 2321559817, 458876584, 1582964031, 1494983747, 2808349651,
        2993436627, 4209579, 4, 1, 749787485, 1969956940, 1785657151, 2094492064, 6, 153727425,
        3923623490, 502231720, 1149216099, 64689942, 1412950283, 296595914, 724802863, 3626907078,
        1767424930, 928770556, 1358239302, 2248049096, 115848421, 1191298443, 3555495242,
        3463625314, 860812537, 3058246234, 4073668375, 1878641723, 3663354012, 449046214,
        3123252198, 2014498544, 336016064, 3568692538, 1369549658, 960565639, 1058345091, 907583503,
        926991181, 2327490371, 1318526341, 1586259481, 1200199099, 1106241778, 2135610413,
        629352393, 266117733, 4018223549, 2834567659, 2843069568, 737214622, 41519050, 2068133468,
        2796529079, 3439123190, 2788099764, 4270416216, 317743227, 3107337037, 346798116,
        3096452908, 3961382707, 69387443, 1, 1239304356, 169441334, 2078447559, 611157482, 5,
        1916015761, 729535613, 3511376996, 924350602, 1598540621, 2155115788, 3789846558, 247373397,
        1115549449, 4206905300, 2492524322, 151972377, 2136385346, 2307522379, 2904654443,
        3131367782, 1940944350, 1520720360, 3208962193, 2008936861, 3655478230, 4087763537,
        1996538171, 1603514391, 762161481, 2158456288, 4266770756, 3167446373, 1073580577,
        328879579, 1760038296, 3377086102, 2715585292, 1084744010, 1652360621, 1735579658,
        1512891621, 4054941899, 829987954, 2398868888, 2512578114, 1000387327, 4036904336,
        1732585137, 2217966532, 2911347829, 4155975348, 2998158577, 1, 1424553579, 1489788301,
        1207779628, 1492070822, 4, 2463107068, 2396338984, 486589748, 3955035326, 2568022762,
        3269196936, 3527326873, 2682504389, 2543610324, 1666314299, 3156411093, 1660029376,
        1341720898, 1233881558, 286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473,
        3316675183, 428630443, 917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132,
        3888923447, 2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664,
        1394083249, 2985963938, 1096029287, 2937190762, 923831270, 1, 998203232, 1168863975,
        2010373232, 569726986, 3, 2710609327, 2216448352, 1104255904, 2190316845, 559242392,
        2565995154, 1081987368, 3123961893, 3316524407, 2989286804, 350671860, 3444044780,
        3599867322, 3717955563, 2469206012, 3493114393, 2150232906, 2233083310, 4159520029,
        4177730940, 969076230, 3988867398, 641127349, 3760798772, 1579344412, 3733969299,
        3661667334, 2492379877, 1914207473, 2258450093, 2313970361, 3330590634, 2, 1027496823,
        1344573853, 647538214, 596545944, 1027496823, 1344573853, 647538214, 596545944, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid last layer degree")]
fn proof_with_invalid_last_layer_degree_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    // The last layer polynomial has degree 1, not 0.
    let mut proof_data = array![
        1, 13485189, 0, 0, 0, 7, 1372005470, 2709444601, 8660353, 1197912763, 2097669106,
        2565886625, 3187301120, 2744122786, 2250434810, 3181375376, 3266303265, 3833375635,
        2532194441, 509336530, 653188657, 2618864049, 1341622493, 3509590667, 3944602181,
        4060530797, 3380169544, 1157610312, 1872689990, 2141220171, 4226953668, 4111689355,
        4085228277, 2534011746, 2702047246, 1796723545, 805991809, 4264028877, 1622198621,
        3132153353, 4069492091, 3348244485, 243523157, 3900443470, 682718364, 3980434338,
        1090002601, 3413214276, 202004026, 2277978075, 3329882806, 964129743, 33493855, 1386628738,
        964597192, 2776971243, 3214987103, 3114412783, 4096873747, 1991897439, 1320631548,
        3720795382, 2581098863, 2321559817, 458876584, 1582964031, 1494983747, 2808349651,
        2993436627, 4209579, 5, 1, 749787485, 1969956940, 1785657151, 2094492064, 6, 153727425,
        3923623490, 502231720, 1149216099, 64689942, 1412950283, 296595914, 724802863, 3626907078,
        1767424930, 928770556, 1358239302, 2248049096, 115848421, 1191298443, 3555495242,
        3463625314, 860812537, 3058246234, 4073668375, 1878641723, 3663354012, 449046214,
        3123252198, 2014498544, 336016064, 3568692538, 1369549658, 960565639, 1058345091, 907583503,
        926991181, 2327490371, 1318526341, 1586259481, 1200199099, 1106241778, 2135610413,
        629352393, 266117733, 4018223549, 2834567659, 2843069568, 737214622, 41519050, 2068133468,
        2796529079, 3439123190, 2788099764, 4270416216, 317743227, 3107337037, 346798116,
        3096452908, 3961382707, 69387443, 1, 1239304356, 169441334, 2078447559, 611157482, 5,
        1916015761, 729535613, 3511376996, 924350602, 1598540621, 2155115788, 3789846558, 247373397,
        1115549449, 4206905300, 2492524322, 151972377, 2136385346, 2307522379, 2904654443,
        3131367782, 1940944350, 1520720360, 3208962193, 2008936861, 3655478230, 4087763537,
        1996538171, 1603514391, 762161481, 2158456288, 4266770756, 3167446373, 1073580577,
        328879579, 1760038296, 3377086102, 2715585292, 1084744010, 1652360621, 1735579658,
        1512891621, 4054941899, 829987954, 2398868888, 2512578114, 1000387327, 4036904336,
        1732585137, 2217966532, 2911347829, 4155975348, 2998158577, 1, 1424553579, 1489788301,
        1207779628, 1492070822, 4, 2463107068, 2396338984, 486589748, 3955035326, 2568022762,
        3269196936, 3527326873, 2682504389, 2543610324, 1666314299, 3156411093, 1660029376,
        1341720898, 1233881558, 286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473,
        3316675183, 428630443, 917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132,
        3888923447, 2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664,
        1394083249, 2985963938, 1096029287, 2937190762, 923831270, 1, 998203232, 1168863975,
        2010373232, 569726986, 3, 2710609327, 2216448352, 1104255904, 2190316845, 559242392,
        2565995154, 1081987368, 3123961893, 3316524407, 2989286804, 350671860, 3444044780,
        3599867322, 3717955563, 2469206012, 3493114393, 2150232906, 2233083310, 4159520029,
        4177730940, 969076230, 3988867398, 641127349, 3760798772, 1579344412, 3733969299,
        3661667334, 2492379877, 1914207473, 2258450093, 2313970361, 3330590634, 1, 1289958476,
        1269481205, 629825842, 404343808, 2, 1997399982, 1150863623, 3077988537, 1592562720,
        4180644372, 3695902351, 1242183647, 2138757765, 157597396, 416205316, 1306999984,
        3134010864, 1159114009, 1404673145, 2096112828, 1034517045, 2667006062, 3451708558,
        2499812827, 3580127931, 1614802170, 1342722998, 2387660695, 3245972151, 2, 1, 0, 0, 0, 1, 0,
        0, 0, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

#[test]
#[should_panic(expected: "Invalid last layer evaluations")]
fn proof_with_invalid_last_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![1, 7, 8].span(), log_domain_size: column_log_size };
    let query_evals = array![
        qm31_const::<1208798379, 0, 0, 0>(), qm31_const::<1086480365, 0, 0, 0>(),
        qm31_const::<1362010196, 0, 0, 0>(),
    ]
        .span();
    // The last layer polynomial has a wrong coefficient.
    let mut proof_data = array![
        3, 13485189, 0, 0, 0, 526587957, 0, 0, 0, 84215338, 0, 0, 0, 8, 1372005470, 2709444601,
        8660353, 1197912763, 2097669106, 2565886625, 3187301120, 2744122786, 3843412106, 3506252054,
        3475164404, 3127603343, 538602610, 3044620856, 3000376916, 1682533385, 1523268079,
        987637855, 1872070916, 1912161146, 1696297714, 1266671162, 3153968366, 3981328542,
        1702359280, 1603647637, 1467503824, 3373548540, 2503524362, 1246389420, 2974798592,
        1935420978, 4226953668, 4111689355, 4085228277, 2534011746, 2702047246, 1796723545,
        805991809, 4264028877, 1622198621, 3132153353, 4069492091, 3348244485, 243523157,
        3900443470, 682718364, 3980434338, 1090002601, 3413214276, 202004026, 2277978075,
        3329882806, 964129743, 33493855, 1386628738, 964597192, 2776971243, 3214987103, 3114412783,
        4096873747, 1991897439, 1320631548, 3720795382, 2581098863, 2321559817, 458876584,
        1582964031, 1494983747, 2808349651, 2993436627, 4209579, 5, 3, 749787485, 1969956940,
        1785657151, 2094492064, 268740264, 927590822, 590371534, 2100100344, 1663524687, 1285378925,
        2108778643, 569164293, 5, 1599265597, 3701777070, 2664126611, 3112227717, 604774970,
        2743447966, 2741163232, 3017678802, 3463625314, 860812537, 3058246234, 4073668375,
        1878641723, 3663354012, 449046214, 3123252198, 2014498544, 336016064, 3568692538,
        1369549658, 960565639, 1058345091, 907583503, 926991181, 2327490371, 1318526341, 1586259481,
        1200199099, 1106241778, 2135610413, 629352393, 266117733, 4018223549, 2834567659,
        2843069568, 737214622, 41519050, 2068133468, 2796529079, 3439123190, 2788099764, 4270416216,
        317743227, 3107337037, 346798116, 3096452908, 3961382707, 69387443, 1, 1592239396,
        1575720304, 903720493, 2076233421, 4, 1115549449, 4206905300, 2492524322, 151972377,
        2136385346, 2307522379, 2904654443, 3131367782, 1940944350, 1520720360, 3208962193,
        2008936861, 3655478230, 4087763537, 1996538171, 1603514391, 762161481, 2158456288,
        4266770756, 3167446373, 1073580577, 328879579, 1760038296, 3377086102, 2715585292,
        1084744010, 1652360621, 1735579658, 1512891621, 4054941899, 829987954, 2398868888,
        2512578114, 1000387327, 4036904336, 1732585137, 2217966532, 2911347829, 4155975348,
        2998158577, 0, 4, 2463107068, 2396338984, 486589748, 3955035326, 2568022762, 3269196936,
        3527326873, 2682504389, 2543610324, 1666314299, 3156411093, 1660029376, 1341720898,
        1233881558, 286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473, 3316675183,
        428630443, 917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132, 3888923447,
        2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664, 1394083249,
        2985963938, 1096029287, 2937190762, 923831270, 1, 998203232, 1168863975, 2010373232,
        569726986, 3, 2710609327, 2216448352, 1104255904, 2190316845, 559242392, 2565995154,
        1081987368, 3123961893, 3316524407, 2989286804, 350671860, 3444044780, 3599867322,
        3717955563, 2469206012, 3493114393, 2150232906, 2233083310, 4159520029, 4177730940,
        969076230, 3988867398, 641127349, 3760798772, 1579344412, 3733969299, 3661667334,
        2492379877, 1914207473, 2258450093, 2313970361, 3330590634, 1, 1289958476, 1269481205,
        629825842, 404343808, 2, 1997399982, 1150863623, 3077988537, 1592562720, 4180644372,
        3695902351, 1242183647, 2138757765, 157597396, 416205316, 1306999984, 3134010864,
        1159114009, 1404673145, 2096112828, 1034517045, 2667006062, 3451708558, 2499812827,
        3580127931, 1614802170, 1342722998, 2387660695, 3245972151, 1, 1578742031, 1356219233,
        1831594076, 1811208960, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

#[test]
#[should_panic]
fn decommit_queries_on_invalid_domain_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let invalid_column_log_size = column_log_size - 1;
    // The queries are sampled on the wrong domain (it has half the required size).
    let invalid_queries = Queries {
        positions: array![1, 7, 8].span(), log_domain_size: invalid_column_log_size,
    };
    let query_evals = array![
        qm31_const::<1208798379, 0, 0, 0>(), qm31_const::<1086480365, 0, 0, 0>(),
        qm31_const::<1362010196, 0, 0, 0>(),
    ]
        .span();
    let mut proof_data = array![
        3, 13485189, 0, 0, 0, 526587957, 0, 0, 0, 84215338, 0, 0, 0, 8, 1372005470, 2709444601,
        8660353, 1197912763, 2097669106, 2565886625, 3187301120, 2744122786, 3843412106, 3506252054,
        3475164404, 3127603343, 538602610, 3044620856, 3000376916, 1682533385, 1523268079,
        987637855, 1872070916, 1912161146, 1696297714, 1266671162, 3153968366, 3981328542,
        1702359280, 1603647637, 1467503824, 3373548540, 2503524362, 1246389420, 2974798592,
        1935420978, 4226953668, 4111689355, 4085228277, 2534011746, 2702047246, 1796723545,
        805991809, 4264028877, 1622198621, 3132153353, 4069492091, 3348244485, 243523157,
        3900443470, 682718364, 3980434338, 1090002601, 3413214276, 202004026, 2277978075,
        3329882806, 964129743, 33493855, 1386628738, 964597192, 2776971243, 3214987103, 3114412783,
        4096873747, 1991897439, 1320631548, 3720795382, 2581098863, 2321559817, 458876584,
        1582964031, 1494983747, 2808349651, 2993436627, 4209579, 5, 3, 749787485, 1969956940,
        1785657151, 2094492064, 268740264, 927590822, 590371534, 2100100344, 1663524687, 1285378925,
        2108778643, 569164293, 5, 1599265597, 3701777070, 2664126611, 3112227717, 604774970,
        2743447966, 2741163232, 3017678802, 3463625314, 860812537, 3058246234, 4073668375,
        1878641723, 3663354012, 449046214, 3123252198, 2014498544, 336016064, 3568692538,
        1369549658, 960565639, 1058345091, 907583503, 926991181, 2327490371, 1318526341, 1586259481,
        1200199099, 1106241778, 2135610413, 629352393, 266117733, 4018223549, 2834567659,
        2843069568, 737214622, 41519050, 2068133468, 2796529079, 3439123190, 2788099764, 4270416216,
        317743227, 3107337037, 346798116, 3096452908, 3961382707, 69387443, 1, 1592239396,
        1575720304, 903720493, 2076233421, 4, 1115549449, 4206905300, 2492524322, 151972377,
        2136385346, 2307522379, 2904654443, 3131367782, 1940944350, 1520720360, 3208962193,
        2008936861, 3655478230, 4087763537, 1996538171, 1603514391, 762161481, 2158456288,
        4266770756, 3167446373, 1073580577, 328879579, 1760038296, 3377086102, 2715585292,
        1084744010, 1652360621, 1735579658, 1512891621, 4054941899, 829987954, 2398868888,
        2512578114, 1000387327, 4036904336, 1732585137, 2217966532, 2911347829, 4155975348,
        2998158577, 0, 4, 2463107068, 2396338984, 486589748, 3955035326, 2568022762, 3269196936,
        3527326873, 2682504389, 2543610324, 1666314299, 3156411093, 1660029376, 1341720898,
        1233881558, 286222759, 3355634728, 2060309714, 147516, 1961329809, 1336380473, 3316675183,
        428630443, 917357917, 402426496, 3583548024, 2277220135, 3914457788, 3805816132, 3888923447,
        2408964815, 781690460, 1789702464, 3224264175, 4236307048, 928766664, 1394083249,
        2985963938, 1096029287, 2937190762, 923831270, 1, 998203232, 1168863975, 2010373232,
        569726986, 3, 2710609327, 2216448352, 1104255904, 2190316845, 559242392, 2565995154,
        1081987368, 3123961893, 3316524407, 2989286804, 350671860, 3444044780, 3599867322,
        3717955563, 2469206012, 3493114393, 2150232906, 2233083310, 4159520029, 4177730940,
        969076230, 3988867398, 641127349, 3760798772, 1579344412, 3733969299, 3661667334,
        2492379877, 1914207473, 2258450093, 2313970361, 3330590634, 1, 1289958476, 1269481205,
        629825842, 404343808, 2, 1997399982, 1150863623, 3077988537, 1592562720, 4180644372,
        3695902351, 1242183647, 2138757765, 157597396, 416205316, 1306999984, 3134010864,
        1159114009, 1404673145, 2096112828, 1034517045, 2667006062, 3451708558, 2499812827,
        3580127931, 1614802170, 1342722998, 2387660695, 3245972151, 1, 1578742030, 1356219233,
        1831594076, 1811208960, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(invalid_queries, query_evals);
}
