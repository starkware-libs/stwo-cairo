use crate::channel::Channel;
use crate::circle::{CirclePointIndexImpl, CosetImpl};
use crate::fields::qm31::qm31_const;
use crate::fri::{FriConfig, FriVerifierImpl};
use crate::poly::circle::CircleEvaluationImpl;
use crate::poly::line::LineDomainImpl;
use crate::queries::{Queries, QueriesImpl};

// TODO(andrew): Add back in with new proof data.
#[test]
#[ignore]
fn valid_proof_passes_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 1, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 4;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<1242514872, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 1381744584, 0, 0, 0, 5,
        248237920038552760115173130164174203123353934176490790804028298292638637730,
        565795211414946469157204288974583864677896605339666153201617364626219012076,
        1429241829308718590475118459587065761194070023556886281836694442445078550767,
        112736985517415102864396627290325395865021582833422635609580236825399909887,
        1734751601212898474594489984934132832871090066333664002442834978729904575960, 0,
        2062842123560885137372604875777049649036399148319124894222012291287950136814, 2, 1,
        99537030, 598645364, 524399856, 124126124, 4,
        1291319665378567694814885574810831136881893448439564944229389185828650376462,
        2249116528260766262796149521495905607529121395331559366029961601830532988670,
        1126517304007438099452497759147854255367428269270252391844854672474276877173,
        1617597733625675487228439398588025564892271376782836689059755775897834180556, 0,
        1983648368674016433209849425227719906723907079145392260477967429097269024313, 1, 1840773062,
        1902846149, 205939217, 1982803611, 3,
        1843248255397560487620908119891030826762716801182907092596379579688005655434,
        1082215532944925120606470745042487858168767126081955019128805741045675298724,
        1887153286672469747773859320549426761925735961972312365901204557604613601081, 0,
        3023413240775455596710093522929806976598221825938778905395287716531056287773, 2, 591023774,
        1634460577, 1933849409, 1639637777, 591023774, 1634460577, 1933849409, 1639637777, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[ignore]
fn valid_proof_with_constant_last_layer_passes_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 0, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 3;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<1059056252, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 520313910, 0, 0, 0, 4,
        2511859689460956062754798212736603971289039205668758416916441010091827960967,
        3116447051172487019914330687758294186696708622072747727020227859480276128456,
        721698868812272649654951509597754221353628194583368094837414807957240128187,
        2322781146978847693424724097972151857550932350708357827088012624999661465745, 0,
        748174431875540733373318683157905446208709800770031351438402873811128343902, 2, 1,
        822799490, 762931150, 1156162632, 2122921032, 3,
        2682605036744925837528395024963644910241648916416714246021123266777932169829,
        2897190808213678224361292969431925141623148330898699376650599616824548437798,
        1696260486512635605141370500725283204493308222655042278770397536250642854003, 0,
        2532324905130335387885988086730858190821881679074630420916383382420280214544, 1, 1262514944,
        1312656862, 371859941, 1063882049, 2,
        3370021968363855570672925386839858344850086742008104500695244207452648849439,
        769840047821584466049489766531807204023233788256576686626168200236190476002, 0,
        3299797690816392573386697551286401640236146406244365528122431092098000056783, 1, 1897124133,
        864171056, 872860971, 139972076, 0,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}


// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic(expected: "Invalid inner layer evaluations")]
#[ignore]
fn proof_with_invalid_inner_layer_evaluation_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 2, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![5].span(), log_domain_size: column_log_size };
    let query_evals = array![qm31_const::<511282811, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 297706028, 0, 0, 0, 7,
        3493776687527140828368497288821880537037420561562730934871129213640366059514,
        1302201433386659022646953262844862660100213350984814381128106468273445814027,
        2779751751011164856195488077852838228707262348063408173412536809957725682863,
        770189832466915170827672871303060560096281402158850180038788106465085477483,
        3069976756114957526059192199103487785556171329209053545239438274409921785053,
        680223131569150133967126151154770375037918917679072010383451469433376284715,
        771087638539779794875017397672832958116409883486068782457639684521745902298, 0,
        2906774104231402115125849245886411734063363715652850229575637428545214370658, 3, 1,
        538440537, 763926843, 297835090, 675450448, 6,
        2323489267184389648904940334524128319335728562719478000757257061595699724409,
        2518355010803493215236742676989937047358819576038995155770467812049853780302,
        1052099319509182016215622541805215392785322937638345954453047023790985619336,
        134724124743202229553669564186632778246758284203279875388625817255285523351,
        747228874504072031948012038628776919639938882961609484616335923189916306269,
        986490867278298294475423346828038671538855090104725084441125913874228017567, 0,
        995524627752196735661894212183970503203430507166601836968508900279938945086, 0, 5,
        3391302796018267639958936865244251298561915156822537900630723309754711190171,
        97439209108437137515782522757217317923887919870294821783405862016101191265,
        1948531947904000762393255748180154743732564980365748228979683960050239935500,
        629549320318792956712638764191845454995553725249231776669667909539065755958,
        2434751759245803082581349704195895480432168147867347790967923582277723748886, 0,
        2149735103824111869949414413764166503122090836900441970959186989416467221143, 1, 294882200,
        730761129, 578956600, 36719417, 4,
        479514794246235700821866475623346973502891730541037606725184106895626377158,
        297309643017702014371545487431545507680516868776245181237311089465722014591,
        2127502746971593028564482961924309171918348094827433337314131210427373210306,
        2206301781526548311677458232607775332450862347745916668552172879217421510381, 0,
        2168899312563977570176790236694005793684040578094317937516080629846982916156, 4, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 2,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
#[ignore]
fn proof_with_added_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 3, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    let mut proof_data = array![
        1, 13485189, 0, 0, 0, 7,
        1018772866886356793591132853402474585086454566523929550724544407378948823808,
        2649771523025999405113769711824400532328865192514853420237355944984638515692,
        2779751751011164856195488077852838228707262348063408173412536809957725682863,
        770189832466915170827672871303060560096281402158850180038788106465085477483,
        3069976756114957526059192199103487785556171329209053545239438274409921785053,
        680223131569150133967126151154770375037918917679072010383451469433376284715,
        771087638539779794875017397672832958116409883486068782457639684521745902298, 0,
        2906774104231402115125849245886411734063363715652850229575637428545214370658, 3, 1,
        1984232051, 1301620570, 1751255046, 2066154700, 6,
        930909046950338848675671179033947720344577278394252394520228351960094703457,
        2518355010803493215236742676989937047358819576038995155770467812049853780302,
        1052099319509182016215622541805215392785322937638345954453047023790985619336,
        134724124743202229553669564186632778246758284203279875388625817255285523351,
        747228874504072031948012038628776919639938882961609484616335923189916306269,
        986490867278298294475423346828038671538855090104725084441125913874228017567, 0,
        995524627752196735661894212183970503203430507166601836968508900279938945086, 1, 1458405795,
        491359394, 695332103, 1156919555, 5,
        3391302796018267639958936865244251298561915156822537900630723309754711190171,
        97439209108437137515782522757217317923887919870294821783405862016101191265,
        1948531947904000762393255748180154743732564980365748228979683960050239935500,
        629549320318792956712638764191845454995553725249231776669667909539065755958,
        2434751759245803082581349704195895480432168147867347790967923582277723748886, 0,
        2149735103824111869949414413764166503122090836900441970959186989416467221143, 1, 294882200,
        730761129, 578956600, 36719417, 4,
        479514794246235700821866475623346973502891730541037606725184106895626377158,
        297309643017702014371545487431545507680516868776245181237311089465722014591,
        2127502746971593028564482961924309171918348094827433337314131210427373210306,
        2206301781526548311677458232607775332450862347745916668552172879217421510381, 0,
        2168899312563977570176790236694005793684040578094317937516080629846982916156, 4, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 2,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic(expected: "Invalid number of FRI layers")]
#[ignore]
fn proof_with_removed_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 1, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 6;
    let mut proof_data = array![
        1, 13485189, 0, 0, 0, 7,
        1018772866886356793591132853402474585086454566523929550724544407378948823808,
        2649771523025999405113769711824400532328865192514853420237355944984638515692,
        2779751751011164856195488077852838228707262348063408173412536809957725682863,
        770189832466915170827672871303060560096281402158850180038788106465085477483,
        3069976756114957526059192199103487785556171329209053545239438274409921785053,
        680223131569150133967126151154770375037918917679072010383451469433376284715,
        771087638539779794875017397672832958116409883486068782457639684521745902298, 0,
        2906774104231402115125849245886411734063363715652850229575637428545214370658, 3, 1,
        1984232051, 1301620570, 1751255046, 2066154700, 6,
        930909046950338848675671179033947720344577278394252394520228351960094703457,
        2518355010803493215236742676989937047358819576038995155770467812049853780302,
        1052099319509182016215622541805215392785322937638345954453047023790985619336,
        134724124743202229553669564186632778246758284203279875388625817255285523351,
        747228874504072031948012038628776919639938882961609484616335923189916306269,
        986490867278298294475423346828038671538855090104725084441125913874228017567, 0,
        995524627752196735661894212183970503203430507166601836968508900279938945086, 1, 1458405795,
        491359394, 695332103, 1156919555, 5,
        3391302796018267639958936865244251298561915156822537900630723309754711190171,
        97439209108437137515782522757217317923887919870294821783405862016101191265,
        1948531947904000762393255748180154743732564980365748228979683960050239935500,
        629549320318792956712638764191845454995553725249231776669667909539065755958,
        2434751759245803082581349704195895480432168147867347790967923582277723748886, 0,
        2149735103824111869949414413764166503122090836900441970959186989416467221143, 1, 294882200,
        730761129, 578956600, 36719417, 4,
        479514794246235700821866475623346973502891730541037606725184106895626377158,
        297309643017702014371545487431545507680516868776245181237311089465722014591,
        2127502746971593028564482961924309171918348094827433337314131210427373210306,
        2206301781526548311677458232607775332450862347745916668552172879217421510381, 0,
        2168899312563977570176790236694005793684040578094317937516080629846982916156, 4, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 92255467,
        1174963615, 663113792, 2066585349, 92255467, 1174963615, 663113792, 2066585349, 2,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic(expected: "Invalid last layer degree")]
#[ignore]
fn proof_with_invalid_last_layer_degree_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 2, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 4;
    let mut proof_data = array![
        3, 466407290, 0, 0, 0, 1657247602, 0, 0, 0, 183082621, 0, 0, 0, 6,
        2191983833872455433114432226011293834134487075743191836614597135553794517005,
        3464840636653936594197539435512969951836467536729265308502051557386128572008,
        222796975636755964353674243152293642953167138800260344804970874742438880851,
        1798533664940731406819278501050858084865711142717794910914770138137877766030,
        112736985517415102864396627290325395865021582833422635609580236825399909887,
        1734751601212898474594489984934132832871090066333664002442834978729904575960, 0,
        2062842123560885137372604875777049649036399148319124894222012291287950136814, 1, 3,
        141033582, 2113260302, 1238696787, 1899978666, 868401741, 698045836, 214810831, 1288148988,
        917728605, 296711650, 1163674366, 578376068, 3,
        1296391960212195064330229477331179473327220696707113566862317562405116506156,
        1126517304007438099452497759147854255367428269270252391844854672474276877173,
        1617597733625675487228439398588025564892271376782836689059755775897834180556, 0,
        1983648368674016433209849425227719906723907079145392260477967429097269024313, 8, 1, 0, 0, 0,
        1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 3,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();

    FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic(expected: "Invalid last layer evaluations")]
#[ignore]
fn proof_with_invalid_last_layer_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 2, log_blowup_factor: 2, n_queries: 3 };
    let column_log_bound = 4;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let queries = Queries { positions: array![1, 7, 8].span(), log_domain_size: column_log_size };
    let query_evals = array![
        qm31_const::<127986842, 0, 0, 0>(), qm31_const::<1816542136, 0, 0, 0>(),
        qm31_const::<18610701, 0, 0, 0>(),
    ]
        .span();
    let mut proof_data = array![
        3, 466407290, 0, 0, 0, 1657247602, 0, 0, 0, 183082621, 0, 0, 0, 6,
        2191983833872455433114432226011293834134487075743191836614597135553794517005,
        3464840636653936594197539435512969951836467536729265308502051557386128572008,
        222796975636755964353674243152293642953167138800260344804970874742438880851,
        1798533664940731406819278501050858084865711142717794910914770138137877766030,
        112736985517415102864396627290325395865021582833422635609580236825399909887,
        1734751601212898474594489984934132832871090066333664002442834978729904575960, 0,
        2062842123560885137372604875777049649036399148319124894222012291287950136814, 1, 3,
        141033582, 2113260302, 1238696787, 1899978666, 868401741, 698045836, 214810831, 1288148988,
        917728605, 296711650, 1163674366, 578376068, 3,
        1296391960212195064330229477331179473327220696707113566862317562405116506156,
        1126517304007438099452497759147854255367428269270252391844854672474276877173,
        1617597733625675487228439398588025564892271376782836689059755775897834180556, 0,
        1983648368674016433209849425227719906723907079145392260477967429097269024313, 4, 129445544,
        2099793146, 401612806, 286217047, 129445543, 2099793146, 401612806, 286217047, 129445543,
        2099793146, 401612806, 286217047, 129445543, 2099793146, 401612806, 286217047, 2,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(queries, query_evals);
}

// TODO(andrew): Add back in with new proof data.
#[test]
#[should_panic]
#[ignore]
fn decommit_queries_on_invalid_domain_fails_verification() {
    let config = FriConfig { log_last_layer_degree_bound: 1, log_blowup_factor: 2, n_queries: 1 };
    let column_log_bound = 3;
    let column_log_size = column_log_bound + config.log_blowup_factor;
    let invalid_column_log_size = column_log_size - 1;
    let invalid_queries = Queries {
        positions: array![5].span(), log_domain_size: invalid_column_log_size,
    };
    let query_evals = array![qm31_const::<1059056252, 0, 0, 0>()].span();
    let mut proof_data = array![
        1, 520313910, 0, 0, 0, 4,
        2511859689460956062754798212736603971289039205668758416916441010091827960967,
        3116447051172487019914330687758294186696708622072747727020227859480276128456,
        721698868812272649654951509597754221353628194583368094837414807957240128187,
        2322781146978847693424724097972151857550932350708357827088012624999661465745, 0,
        748174431875540733373318683157905446208709800770031351438402873811128343902, 1, 1,
        822799490, 762931150, 1156162632, 2122921032, 3,
        2682605036744925837528395024963644910241648916416714246021123266777932169829,
        2897190808213678224361292969431925141623148330898699376650599616824548437798,
        1696260486512635605141370500725283204493308222655042278770397536250642854003, 0,
        2532324905130335387885988086730858190821881679074630420916383382420280214544, 2, 1901985872,
        2023841224, 1529482466, 2072637482, 1901985872, 2023841224, 1529482466, 2072637482, 1,
    ]
        .span();
    let proof = Serde::deserialize(ref proof_data).unwrap();
    let mut channel: Channel = Default::default();
    let mut verifier = FriVerifierImpl::commit(ref channel, config, proof, column_log_bound);

    verifier.decommit(invalid_queries, query_evals);
}
